{
    "info": {
        "name": "Book Management API Tests",
        "description": "Complete test suite for Book API with automated tests",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "auth": {
        "type": "bearer",
        "bearer": [
            {
                "key": "token",
                "value": "{{auth_token}}",
                "type": "string"
            }
        ]
    },
    "item": [
        {
            "name": "Authentication",
            "item": [
                {
                    "name": "Login Success",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "// Test 1: Status code là 200",
                                    "pm.test(\"Status code is 200\", function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "// Test 2: Response time < 500ms",
                                    "pm.test(\"Response time is less than 500ms\", function () {",
                                    "    pm.expect(pm.response.responseTime).to.be.below(500);",
                                    "});",
                                    "",
                                    "// Test 3: Response có đúng structure",
                                    "pm.test(\"Response has correct structure\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData).to.have.property('status');",
                                    "    pm.expect(jsonData).to.have.property('data');",
                                    "    pm.expect(jsonData).to.have.property('message');",
                                    "    pm.expect(jsonData.status).to.eql('success');",
                                    "});",
                                    "",
                                    "// Test 4: Token được trả về",
                                    "pm.test(\"Token is present\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.data).to.have.property('token');",
                                    "    pm.expect(jsonData.data.token).to.be.a('string');",
                                    "    pm.expect(jsonData.data.token.length).to.be.above(0);",
                                    "});",
                                    "",
                                    "// Lưu token vào environment",
                                    "var jsonData = pm.response.json();",
                                    "pm.environment.set(\"auth_token\", jsonData.data.token);",
                                    "",
                                    "// Test 5: Content-Type header",
                                    "pm.test(\"Content-Type is application/json\", function () {",
                                    "    pm.response.to.have.header(\"Content-Type\");",
                                    "    pm.expect(pm.response.headers.get(\"Content-Type\")).to.include(\"application/json\");",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Content-Type",
                                "value": "application/json"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"123456\"\n}"
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/login",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "login"
                            ]
                        }
                    }
                },
                {
                    "name": "Login Failed - Invalid Credentials",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 401\", function () {",
                                    "    pm.response.to.have.status(401);",
                                    "});",
                                    "",
                                    "pm.test(\"Error message is correct\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.status).to.eql('error');",
                                    "    pm.expect(jsonData.message).to.eql('Invalid credentials');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"username\": \"wrong\",\n  \"password\": \"wrong\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/login",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "login"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "Books - CRUD Operations",
            "item": [
                {
                    "name": "Get All Books",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "// Test 1: Status code",
                                    "pm.test(\"Status code is 200\", function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "// Test 2: Response structure",
                                    "pm.test(\"Response has books array\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.data).to.have.property('books');",
                                    "    pm.expect(jsonData.data.books).to.be.an('array');",
                                    "});",
                                    "",
                                    "// Test 3: ETag header present",
                                    "pm.test(\"ETag header is present\", function () {",
                                    "    pm.response.to.have.header(\"ETag\");",
                                    "    var etag = pm.response.headers.get(\"ETag\");",
                                    "    pm.environment.set(\"book_etag\", etag);",
                                    "});",
                                    "",
                                    "// Test 4: Cache-Control header",
                                    "pm.test(\"Cache-Control header is present\", function () {",
                                    "    pm.response.to.have.header(\"Cache-Control\");",
                                    "});",
                                    "",
                                    "// Test 5: Book structure validation",
                                    "pm.test(\"Books have correct structure\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    if (jsonData.data.books.length > 0) {",
                                    "        var book = jsonData.data.books[0];",
                                    "        pm.expect(book).to.have.property('_id');",
                                    "        pm.expect(book).to.have.property('title');",
                                    "        pm.expect(book).to.have.property('author');",
                                    "        pm.expect(book).to.have.property('available');",
                                    "    }",
                                    "});",
                                    "",
                                    "// Test 6: Performance",
                                    "pm.test(\"Response time is acceptable\", function () {",
                                    "    pm.expect(pm.response.responseTime).to.be.below(1000);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/v1/books",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books"
                            ]
                        }
                    }
                },
                {
                    "name": "Create Book",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "// Test 1: Status code",
                                    "pm.test(\"Status code is 201\", function () {",
                                    "    pm.response.to.have.status(201);",
                                    "});",
                                    "",
                                    "// Test 2: Book created successfully",
                                    "pm.test(\"Book created with correct data\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.status).to.eql('success');",
                                    "    pm.expect(jsonData.data).to.have.property('_id');",
                                    "    pm.expect(jsonData.data.title).to.eql('Test Book');",
                                    "    pm.expect(jsonData.data.author).to.eql('Test Author');",
                                    "    pm.expect(jsonData.data.available).to.be.true;",
                                    "});",
                                    "",
                                    "// Save book ID for later use",
                                    "var jsonData = pm.response.json();",
                                    "pm.environment.set(\"test_book_id\", jsonData.data._id);",
                                    "",
                                    "// Test 3: Message",
                                    "pm.test(\"Success message is correct\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.message).to.eql('Book created');",
                                    "});",
                                    "",
                                    "// Test 4: ETag generated",
                                    "pm.test(\"ETag is generated\", function () {",
                                    "    pm.response.to.have.header(\"ETag\");",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"title\": \"Test Book\",\n  \"author\": \"Test Author\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/books",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books"
                            ]
                        }
                    }
                },
                {
                    "name": "Get Book By ID",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test(\"Book details are correct\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.data._id).to.eql(pm.environment.get(\"test_book_id\"));",
                                    "    pm.expect(jsonData.data).to.have.property('title');",
                                    "    pm.expect(jsonData.data).to.have.property('author');",
                                    "});",
                                    "",
                                    "pm.test(\"ETag is present\", function () {",
                                    "    pm.response.to.have.header(\"ETag\");",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/v1/books/{{test_book_id}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books",
                                "{{test_book_id}}"
                            ]
                        }
                    }
                },
                {
                    "name": "Update Book",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test(\"Book updated successfully\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.status).to.eql('success');",
                                    "    pm.expect(jsonData.data.title).to.eql('Updated Test Book');",
                                    "    pm.expect(jsonData.data.available).to.be.false;",
                                    "    pm.expect(jsonData.message).to.eql('Book updated');",
                                    "});",
                                    "",
                                    "pm.test(\"ETag changed after update\", function () {",
                                    "    var newEtag = pm.response.headers.get(\"ETag\");",
                                    "    var oldEtag = pm.environment.get(\"book_etag\");",
                                    "    pm.expect(newEtag).to.not.eql(oldEtag);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "PUT",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"title\": \"Updated Test Book\",\n  \"available\": false\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/books/{{test_book_id}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books",
                                "{{test_book_id}}"
                            ]
                        }
                    }
                },
                {
                    "name": "Delete Book",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test(\"Book deleted successfully\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.status).to.eql('success');",
                                    "    pm.expect(jsonData.message).to.eql('Book deleted');",
                                    "});",
                                    "",
                                    "pm.test(\"Response time is acceptable\", function () {",
                                    "    pm.expect(pm.response.responseTime).to.be.below(500);",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "DELETE",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/v1/books/{{test_book_id}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books",
                                "{{test_book_id}}"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "Books - Filtering",
            "item": [
                {
                    "name": "Filter Available Books",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test(\"All books are available\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    jsonData.data.books.forEach(function(book) {",
                                    "        pm.expect(book.available).to.be.true;",
                                    "    });",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/v1/books?available=true",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books"
                            ],
                            "query": [
                                {
                                    "key": "available",
                                    "value": "true"
                                }
                            ]
                        }
                    }
                },
                {
                    "name": "Search By Title",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\", function () {",
                                    "    pm.response.to.have.status(200);",
                                    "});",
                                    "",
                                    "pm.test(\"Books contain search term\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    jsonData.data.books.forEach(function(book) {",
                                    "        pm.expect(book.title.toLowerCase()).to.include('clean');",
                                    "    });",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/v1/books?title=clean",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books"
                            ],
                            "query": [
                                {
                                    "key": "title",
                                    "value": "clean"
                                }
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "Error Cases",
            "item": [
                {
                    "name": "Get Non-existent Book",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 404\", function () {",
                                    "    pm.response.to.have.status(404);",
                                    "});",
                                    "",
                                    "pm.test(\"Error message is correct\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.status).to.eql('error');",
                                    "    pm.expect(jsonData.message).to.eql('Book not found');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "header": [],
                        "url": {
                            "raw": "{{base_url}}/api/v1/books/507f1f77bcf86cd799439011",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books",
                                "507f1f77bcf86cd799439011"
                            ]
                        }
                    }
                },
                {
                    "name": "Create Book Without Required Fields",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 400\", function () {",
                                    "    pm.response.to.have.status(400);",
                                    "});",
                                    "",
                                    "pm.test(\"Error message mentions missing fields\", function () {",
                                    "    var jsonData = pm.response.json();",
                                    "    pm.expect(jsonData.status).to.eql('error');",
                                    "    pm.expect(jsonData.message).to.include('Missing');",
                                    "});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"title\": \"Only Title\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/v1/books",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "v1",
                                "books"
                            ]
                        }
                    }
                }
            ]
        }
    ],
    "variable": [
        {
            "key": "base_url",
            "value": "http://localhost:5001",
            "type": "string"
        }
    ]
}